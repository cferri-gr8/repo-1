name: Workflow Sync
on:
  repository_dispatch:
    types: [sync-workflow]
jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: main

      - name: Checkout workflows repo
        uses: actions/checkout@v2
        with:
          repository: cferri-gr8/github-workflows
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: workflows

      - name: Copy workflow
        run: cp workflows/${{ github.event.client_payload.workflow }} main/.github/workflows/ci.yml

      - name: Stage
        id: stage
        run: |
          cd main
          git config --global user.name github-actions
          git status
          echo ::set-output name=status::$(git status --porcelain)

      - name: Commit
        if: steps.stage.status != ''
        run: |
          git add .github/workflows/ci.yml
          git commit -m 'Update from ${{ github.event.client_payload.repository }} CICD ${{ github.event.client_payload.sha }}'
          git push https://cferri-gr8:${{ secrets.REPO_ACCESS_TOKEN }}@github.com/${{ github.repository }}.git
